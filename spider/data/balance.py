# 数据地址：http://emweb.securities.eastmoney.com/PC_HSF10/FinanceAnalysis/FinanceAnalysisAjax?code=sh600000&ctype=3
# 字段对照：http://emweb.securities.eastmoney.com/f10_v2/FinanceAnalysis.aspx?type=web&code=sh600000

import pandas as pd
import urllib.request
import json

class Balance(object):
	"""docstring for Balance"""
	def __init__(self, code):
		self.code = code

	def get(self):
		rawData = download(self.code)
		report_head = getReportDetail()
		reportData = {
			'balance':pd.DataFrame(rawData['report']['zcfz'+str(rawData['report']['qylx'])]),
			'profit':pd.DataFrame(rawData['report']['lr'+str(rawData['report']['qylx'])]),
			'cash':pd.DataFrame(rawData['report']['xjll'+str(rawData['report']['qylx'])]),
		}
# 杜邦分析字段
		zb_head = {
        "date": "日期",
        "jbmgsy": "基本每股收益",
        "kfmgsy": "扣非每股收益",
        "xsmgsy": "稀释每股收益",
        "mgjzc": "每股净资产",
        "mggjj": "每股公积金",
        "mgwfply": "每股未分配利润",
        "mgjyxjl": "每股经营现金流",
        "yyzsr": "营业总收入",
        "mlr": "毛利润",
        "gsjlr": "归属净利润",
        "kfjlr": "扣非净利润",
        "yyzsrtbzz": "营业总收入同比增长",
        "gsjlrtbzz": "归属净利润同比增长",
        "kfjlrtbzz": "扣非净利润同比增长",
        "yyzsrgdhbzz": "营业总收入滚动环比增长",
        "gsjlrgdhbzz": "归属净利润滚动环比增长",
        "kfjlrgdhbzz": "扣非净利润滚动环比增长",
        "jqjzcsyl": "加权净资产收益率",
        "tbjzcsyl": "摊薄净资产收益率",
        "tbzzcsyl": "摊薄总资产收益率",
        "mll": "毛利率",
        "jll": "净利率",
        "sjsl": "实际税率",
        "yskyysr": "预收款/营业收入",
        "xsxjlyysr": "销售现金流/营业收入",
        "jyxjlyysr": "经营现金流/营业收入",
        "zzczzy": "总资产周转率",
        "yszkzzts": "应收账款周转天数",
        "chzzts": "存货周转天数",
        "zcfzl": "资产负债率",
        "ldzczfz": "流动负债/总负债",
        "ldbl": "流动比率",
        "sdbl": "速动比率"
}
		db_head = {
          "date": "日期",
          "jzcsyl": "净资产收益率",
          "zzcjll": "总资产净利率",
          "gsmgsgddjlr": "归属母公司股东的净利润占比",
          "qycs": "权益乘数",
          "yyjlrl": "营业净利润率",
          "zzczzl": "总资产周转率",
          "zcfzl": "资产负债率",
          "jlr": "净利润",
          "yysr": "营业总收入",
          "zcze": "资产总额",
          "fzze": "负债总额",
          "srze": "收入总额",
          "cbze": "成本总额",
          "ldzc": "流动资产",
          "fldzc": "非流动资产",
          "yycb": "营业成本",
          "qjfy": "期间费用",
          "hbzj": "货币资金",
          "kgcsjrzc": "可供出售金融资产",
          "wxzc": "无形资产",
          "gyjzbdsy": "公允价值变动损益",
          "yysjjfj": "营业税金及附加",
          "jyxjrzc": "交易性金融资产",
          "cyzdqtz": "持有至到期投资",
          "kfzc": "开发支出",
          "yywsr": "营业外收入",
          "sdsfy": "所得税费用",
          "cwfy": "财务费用",
          "yszk": "应收账款",
          "cqgqtz": "长期股权投资",
          "sy": "商誉",
          "tzsy": "投资收益",
          "zcjzss": "资产减值损失",
          "xsfy": "销售费用",
          "yfzk": "预付账款",
          "tzxfdc": "投资性房地产",
          "cqdtfy": "长期待摊费用",
          "yywzc": "营业外支出",
          "glfy": "管理费用",
          "qtysk": "其他应收款",
          "gdzc": "固定资产",
          "dysdszc": "递延所得税资产",
          "ch": "存货",
          "zjgc": "在建工程",
          "qtfldzc": "其他非流动性资产",
          "qtldzc": "其他流动资产"
          }
		return {
			'index':pd.DataFrame(rawData['index']).rename(columns=zb_head),
			'db':pd.DataFrame(rawData['db']).rename(columns=db_head),
			'balance':reportData['balance'].rename(columns=report_head['balance']),
			'profit':reportData['profit'].rename(columns=report_head['profit']),
			'cash':reportData['cash'].rename(columns=report_head['cash'])
		}

# data_json格式：
# dict_keys(['zyzb', 'dbfx', 'bbmx', 'bfbbb'])
# 'zyzb':'主要指标','dbfx':'杜邦分析','bbmx':'报表明细','bfbbb':'百分比报表'
# 杜邦分析~'bgq':'报告期[季度]','nd':'年度'
# 
def download(code):
	url = 'http://emweb.securities.eastmoney.com/PC_HSF10/FinanceAnalysis/FinanceAnalysisAjax?code=sh{}'.format(code)
	data = urllib.request.urlopen(url).read()
	data_json = json.loads(data)['Result']
	return {
		"index":data_json['zyzb'],
		"db":data_json['dbfx']['nd'],
		"report":data_json['bbmx'],
		"percent":data_json['bfbbb']
	}

def getReportDetail():
	balance_head = {
"date":"日期",
"hbzj":"货币资金",
"yszk":"应收账款",
"qtysk":"其它应收款",
"ch":"存货",
"ldzchj":"流动资产合计",
"cqgqtz":"长期股权投资",
"ljzj":"累计折旧",
"gdzc":"固定资产",
"wxzc":"无形资产",
"zczj":"资产总计",
"yfzk":"应付账款",
"yszk1":"预收账款",
"chdjzb":"存货跌价准备",
"ldfzhj":"流动负债合计",
"cqfzhj":"长期负债合计",
"fzhj":"负债合计",
"sszb":"实收资本",
"zbgjj":"资本公积",
"yygjj":"盈余公积",
"gdqyhj":"股东权益合计",
"ldbl":"流动比率", # 银行专用3
"xjjcfzyyhkx":"现金及存放中央银行款项",
"cftyhqtjrjgkx":"存放同业和其它金融机构款项",
"gjs":"贵金属",
"cczj":"拆出资金",
"jyxjrzc":"交易性金融资产",
"ysjrzc":"衍生金融资产",
"mrfhjrzj":"买入返售金融资产",
"yslx":"应收利息",
"ffdkjdk":"发放贷款及垫款",
"dlywzc":"代理业务资产",
"kgcsjrzc":"可供出售金融资产",
"cyzdqtz":"持有至到期投资",
"tzxfdc":"投资性房地产",
"qtzc":"其他资产",
"tyhqtjrjgcfkx":"同业和其它金融机构存放款项",
"xzyyhjk":"向中央银行借款",
"crzj":"拆入资金",
"jyxjrfz":"交易性金融负债",
"ysjrfz":"衍生金融负债",
"mchgjrzck":"卖出回购金融资产款",
"xsck":"吸收存款", # "yszk":"预收账款[银行]",
"yfzgxc":"应付职工薪酬",
"yjsf":"应交税费",
"yflx":"应付利息",
"dlywfz":"代理业务负债",
"yfzq":"应付债券",
"dysdsfz":"递延所得税负债",
"yjfz":"预计负债",
"qtfz":"其他负债",
"gb":"股本",
"kcg":"库存股",
"wfplr":"未分配利润",
"ybfxzb":"一般风险准备",
"wbbbzsce":"外币报表折算差额",
"ssgdqy":"少数股东权益",
"gsymgssyzqyhj":"归属于母公司所有者权益合计",
"syzqyhj":"所有者权益合计",
"fzjgdqyzj":"负债及股东权益总计", # 证券专用1
"khzjck":"客户资金存款",
"jsbfj":"结算备付金",
"khbfj":"客户备付金",
"ysxjrzc":"衍生金融资产",
"mrfsjrzc":"买入返售金融资产",
"ccbzj":"存出保证金",
"jyxwf":"交易席位费",
"dysdszc":"递延所得税资产",
"dqjk":"短期借款",
"zyjk":"质押借款",
"dlmmzqk":"代理买卖证券款",
"dlcxzqk":"代理承销证券款",
"cqjk":"长期借款", # 保险专用2
"ysbf":"应收保费",
"ysdwzck":"应收代位追偿款",
"ysfdzk":"应收分保账款",
"ysfbwdqzrzbj":"应收分保未到期责任准备金",
"ysfbwjpczbj":"应收分保未决赔款准备金",
"ysfbsxzrzbj":"应收分保寿险责任准备金",
"ysfbcqjkxzrzbj":"应收分保长期健康险责任准备金",
"bhzydk":"保户质押贷款",
"cczbbzj":"存出资本保证金",
"dlzhzc":"独立账户资产",
"dqck":"定期存款",
"ysbf1":"预收保费",
"yfsxfjyj":"应付手续费及佣金",
"yffbzk":"应付分保账款",
"yfpfk":"应付赔付款",
"yfbdhl":"应付保单红利",
"bhcjjtzk":"保户储金及投资款",
"wdqzrzbj":"未到期责任准备金",
"wjpkzbj":"未决赔款准备金",
"sxzrzbj":"寿险责任准备金",
"cqjkxzrzbj":"长期健康险责任准备金",
"dlzhfz":"独立账户负债"
	}
	profit_head = {
"date":"日期",
"yysr":"营业收入",
"yycb":"营业成本",
"xsfy":"销售费用",
"cwfy":"财务费用",
"glfy":"管理费用",
"zcjzss":"资产减值损失",
"tzsy":"投资收益",
"yylr":"营业利润",
"lrze":"利润总额",
"sds":"所得税",
"gsmgssyzjlr":"归属母公司所有者净利润", # 银行专用
"lxjsr":"利息净收入",
"lxsr":"利息收入",
"lxzc":"利息支出",
"sxfjyjjsr":"手续费及佣金净收入",
"sxfjyjsr":"手续费及佣金收入",
"sxfjyjzc":"手续费及佣金支出",
"dlyqyhhyqydtzsy":"对联营企业和合营企业的投资收益",
"gyjzbds":"公允价值变动收益",
"hdsy":"汇兑收益",
"qtywsr":"其他业务收入",
"yyzc":"营业支出",
"yysjjfj":"营业税金及附加",
"qtywcb":"其他业务成本",
"yywsr":"营业外收入",
"yywzc":"营业外支出",
"jlr":"净利润",
"ssgdsy":"少数股东损益", # 证券专用
"dlmmzqywjsr":"代理买卖证券业务净收入",
"zqcxywjsr":"证券承销业务净收入",
"stkhzcglywjsr":"受托客户资产管理业务净收入",
"zlyqyhhyqydtzsy":"对联营企业和合营企业的投资收益", # 保险专用
"yzbf":"已赚保费",
"bfywsr":"保费业务收入",
"fbfsr":"分保费收入",
"fcbf":"分出保费",
"tqwdqzrzbj":"提取未到期责任准备金",
"tbj":"退保金",
"pfzc":"赔付支出",
"thpfzc":"摊回赔付支出",
"tqbxzrzbj":"提取保险责任准备金",
"thbxzrzbj":"摊回保险责任准备金",
"bhhlzc":"保户红利支出",
"fbfy":"分保费用",
"thfbfy":"摊回分保费用"
	}
	cash_head = {
"date":"日期",
"sddxj":"销售商品、提供劳务收到的现金",
"sddsffh":"收到的税费返还",
"sdqtdxj":"收到其他与经营活动有关的现金",
"jyhdxjlrxj":"经营活动现金流入小计",
"gmspjslwzfdxj":"购买商品、接受劳务支付的现金",
"zfgzgyjwzgzfdxj":"支付给职工以及为职工支付的现金",
"zfdgxsf":"支付的各项税费",
"zfqtyjyhdygdxj":"支付其他与经营活动有关的现金",
"jyhdxjlcxj":"经营活动现金流出小计",
"jyhdcsdxjllje":"经营活动产生的现金流量净额",
"qdtzsyssddxj":"取得投资收益所收到的现金",
"shdxjje":"处置固定资产、无形资产和其他长期资产收回的现金净额",
"tzhdxjlrxj":"投资活动现金流入小计",
"zfdxj":"购建固定资产、无形资产和其他长期资产支付的现金",
"zfdxjje":"处置固定资产、无形资产和其他长期资产支付的现金净额",
"tzzfdxj":"投资支付的现金",
"tzhdxjlcxj":"投资活动现金流出小计",
"tzhdcsdxjllje":"投资活动产生的现金流量净额",
"xstzsddxj":"吸收投资收到的现金",
"qdjksddxj":"取得借款收到的现金",
"czhdxjlrxj":"筹资活动现金流入小计",
"chzwzfdxj":"偿还债务支付的现金",
"fpzfdxj":"分配股利、利润或偿付利息支付的现金",
"czhdxjlcxj":"筹资活动现金流出小计",
"czhdcsdxjllje":"筹资活动产生的现金流量净额", # 银行专用
"khckhtycfkxjzje":"客户存款和同业存放款项净增加额",
"xzyyhjkjzje":"向中央银行借款净增加额",
"xqtjrjgcrzjjzje":"向其他金融机构拆入资金净增加额",
"sqlxhsxfjzje":"收取利息和手续费净增加额",
"sdqtyjyhdygdxj":"收到其他与经营活动有关的现金",
"khdkjdkjzje":"客户贷款及垫款净增加额",
"cfyhhtykxjzje":"存放央行和同业款项净增加额",
"shtzsddxj":"收回投资收到的现金",
"sddxjje":"处置子公司及其他营业单位收到的现金净额",
"sdqtytzhdygdxj":"收到其他与投资活动有关的现金",
"zfqtytzhdygdxj":"支付其他与投资活动有关的现金",
"xstzsddxj":"吸收投资收到的现金",
"fxzqsddxj":"发行债券收到的现金",
"sdqtyczhdygdxj":"收到其他与筹资活动有关的现金",
"zfqtyczhdygdxj":"支付其他与筹资活动有关的现金",
"hlbddxjdyx":"汇率变动对现金的影响",
"xjjxjdjwjzje":"现金及现金等价物净增加额",
"qcxjjxjdjwye":"期初现金及现金等价物余额",
"qmxjjxjdjwye":"期末现金及现金等价物余额", # 证券专用
"qdtzsyssddxj":"取得投资收益收到的现金",
"shdxjje1":"处置子公司及其他营业单位收到的现金净额", # 保险专用
"sdybxhtbfqddxj":"收到原保险合同保费取得的现金",
"sdzbywxjje":"收到再保业务现金净额",
"bhcjjzje":"保户储金净增加额",
"zfpfkxdxj":"支付赔付款项的现金",
"zfsxfdxj":"支付手续费的现金",
"zfgzgyjwzjzfdxj":"支付给职工以及为职工支付的现金",
"qdtzsysddxj":"取得投资收益收到的现金",
"zydkjzje":"质押贷款净增加额"
	}
	return {
		'balance':balance_head,
		'profit':profit_head,
		'cash':cash_head
	}